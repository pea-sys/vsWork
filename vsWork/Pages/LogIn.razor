@page "/"
@using Microsoft.AspNetCore.Components.Server.Circuits;
<EditForm Model="@authUser" OnValidSubmit="OnValidSubmit">
    <FluentValidationValidator @ref="fluentValidationValidator " />
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="form-group">
        <label for="id">UserID</label>
        <input type="text" name="id" @bind-value="authUser.UserId" maxlength="100" class="form-control" />
    </div>
    <div class="form-group">
        <label for="pass">Password</label>
        <input type="password" name="pass" @bind-value="authUser.Password" maxlength="100" class="form-control" />
    </div>
    <div class="form-group">
        <input type="checkbox" name="isChache" @bind-value="isCache">
        <label for="isChache">ログイン状態を維持</label>
    </div>
    <button class="btn btn-primary" type="submit">ログイン</button>
</EditForm>

@code{
    [Inject]
    protected NavigationManager NavManager { get; set; }
    [Inject]
    protected IRepository<User, string> userRepository { get; set; }
    [Inject]
    protected IRepository<Session, string> sessionRepository { get; set; }
    [Inject]
    protected CircuitHandler circuitHandlerServive { get; set; }
    [Inject]
    protected IUserOnlineService UserOnlineService { get; set; }
    [Inject]
    protected CurrentUserService currentUserService { get; set; }

    private FluentValidationValidator fluentValidationValidator;

    private User authUser = new User();
    private bool isCache = false;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
#if DEBUG
        userRepository.CreateTable();
        userRepository.Add(new User { UserId = "helloworld", Password = "helloworld",UserName="UserName" });
        userRepository.Update(new User { UserId = "helloworld", Password = "helloworld" });
        userRepository.Add(new User { UserId = "apple", Password = "apple" });


        sessionRepository.CreateTable();
#endif
    }
    /// <summary>
    /// サブミット押下処理
    /// </summary>
    private async Task OnValidSubmit()
    {
        currentUserService.CircuitId = ((CircuitHandlerService)circuitHandlerServive).CircuitId;
        currentUserService.UserId = authUser.UserId;
        currentUserService.UserName = authUser.UserName;

        UserOnlineService.Connect(currentUserService, (SessionRepository)sessionRepository);
        NavManager.NavigateTo("top");
    }
}
